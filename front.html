<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>RAG Assistant</title>
  <link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Mono:ital,wght@0,300;0,400;1,300&display=swap" rel="stylesheet"/>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg: #0b0c0f;
      --surface: #13151a;
      --surface2: #1c1f27;
      --border: #2a2d38;
      --accent: #7fff6e;
      --accent2: #3dffc0;
      --danger: #ff6b6b;
      --text: #e8eaf0;
      --muted: #6b7080;
      --user-bg: #1a2a1a;
      --ai-bg: #131820;
    }

    html, body { height: 100%; background: var(--bg); color: var(--text); font-family: 'DM Mono', monospace; overflow: hidden; }

    body::before {
      content: '';
      position: fixed; inset: 0;
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.04'/%3E%3C/svg%3E");
      pointer-events: none; z-index: 0;
    }

    .app {
      display: grid;
      grid-template-columns: 280px 1fr;
      grid-template-rows: 100vh;
      height: 100vh;
      position: relative;
      z-index: 1;
    }

    /* ‚îÄ‚îÄ Sidebar ‚îÄ‚îÄ */
    .sidebar {
      background: var(--surface);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      padding: 24px 20px;
      gap: 20px;
      overflow-y: auto;
    }

    .sidebar-logo {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .logo-box {
      width: 34px; height: 34px;
      border: 2px solid var(--accent);
      border-radius: 8px;
      display: grid; place-items: center;
      animation: pulse 3s ease-in-out infinite;
    }

    @keyframes pulse {
      0%,100% { box-shadow: 0 0 0 0 rgba(127,255,110,0.4); }
      50% { box-shadow: 0 0 0 8px rgba(127,255,110,0); }
    }

    .logo-box svg { width: 16px; height: 16px; fill: var(--accent); }

    .logo-text h1 { font-family: 'Syne', sans-serif; font-size: 1rem; font-weight: 800; }
    .logo-text p { font-size: 0.62rem; color: var(--muted); margin-top: 2px; }

    .sidebar-section-title {
      font-size: 0.62rem;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.1em;
      margin-bottom: -8px;
    }

    /* Upload zone */
    .upload-zone {
      border: 2px dashed var(--border);
      border-radius: 12px;
      padding: 24px 16px;
      text-align: center;
      cursor: pointer;
      transition: all 0.25s ease;
      position: relative;
    }

    .upload-zone:hover, .upload-zone.drag-over {
      border-color: var(--accent);
      background: rgba(127,255,110,0.04);
    }

    .upload-zone input[type="file"] {
      position: absolute; inset: 0; opacity: 0; cursor: pointer; width: 100%; height: 100%;
    }

    .upload-icon { font-size: 1.8rem; margin-bottom: 10px; }

    .upload-zone p {
      font-size: 0.72rem;
      color: var(--muted);
      line-height: 1.6;
    }

    .upload-zone span {
      color: var(--accent);
      font-size: 0.72rem;
    }

    .file-types {
      display: flex;
      gap: 6px;
      justify-content: center;
      margin-top: 10px;
    }

    .file-badge {
      font-size: 0.6rem;
      padding: 3px 8px;
      border-radius: 4px;
      background: var(--surface2);
      border: 1px solid var(--border);
      color: var(--muted);
    }

    /* Upload progress */
    .upload-status {
      display: none;
      flex-direction: column;
      gap: 8px;
    }

    .upload-status.show { display: flex; }

    .progress-bar-wrap {
      background: var(--surface2);
      border-radius: 4px;
      height: 4px;
      overflow: hidden;
    }

    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      border-radius: 4px;
      width: 0%;
      transition: width 0.3s ease;
    }

    .upload-status-text {
      font-size: 0.68rem;
      color: var(--muted);
    }

    /* Active document card */
    .active-doc {
      display: none;
      background: var(--surface2);
      border: 1px solid rgba(127,255,110,0.25);
      border-radius: 10px;
      padding: 14px;
      gap: 10px;
      flex-direction: column;
    }

    .active-doc.show { display: flex; }

    .doc-header {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .doc-icon {
      width: 32px; height: 32px;
      background: rgba(127,255,110,0.1);
      border: 1px solid rgba(127,255,110,0.3);
      border-radius: 6px;
      display: grid; place-items: center;
      font-size: 0.9rem;
      flex-shrink: 0;
    }

    .doc-info { flex: 1; min-width: 0; }
    .doc-name {
      font-size: 0.72rem;
      color: var(--text);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .doc-meta { font-size: 0.62rem; color: var(--accent); margin-top: 2px; }

    .doc-clear-btn {
      background: none;
      border: 1px solid var(--border);
      color: var(--muted);
      font-family: 'DM Mono', monospace;
      font-size: 0.62rem;
      padding: 6px 10px;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
      width: 100%;
    }

    .doc-clear-btn:hover { border-color: var(--danger); color: var(--danger); }

    /* Suggestions */
    .suggestions-list { display: flex; flex-direction: column; gap: 6px; }

    .suggestion-btn {
      background: var(--surface2);
      border: 1px solid var(--border);
      color: var(--muted);
      font-family: 'DM Mono', monospace;
      font-size: 0.67rem;
      padding: 9px 12px;
      border-radius: 8px;
      cursor: pointer;
      text-align: left;
      transition: all 0.2s ease;
      line-height: 1.4;
    }

    .suggestion-btn:hover:not(:disabled) {
      border-color: var(--accent);
      color: var(--accent);
      background: rgba(127,255,110,0.04);
    }

    .suggestion-btn:disabled { opacity: 0.35; cursor: not-allowed; }

    /* ‚îÄ‚îÄ Main ‚îÄ‚îÄ */
    .main {
      display: grid;
      grid-template-rows: auto 1fr auto;
      overflow: hidden;
    }

    /* Header */
    .top-bar {
      padding: 18px 28px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .top-bar-left { font-size: 0.72rem; color: var(--muted); }
    .top-bar-left span { color: var(--accent); }

    .status { display: flex; align-items: center; gap: 8px; font-size: 0.68rem; color: var(--muted); }
    .status-dot { width: 7px; height: 7px; border-radius: 50%; background: var(--accent); animation: blink 2s ease-in-out infinite; }
    @keyframes blink { 0%,100%{opacity:1;} 50%{opacity:0.3;} }

    /* Chat */
    .chat-area {
      overflow-y: auto;
      padding: 28px;
      display: flex;
      flex-direction: column;
      gap: 20px;
      scroll-behavior: smooth;
    }

    .chat-area::-webkit-scrollbar { width: 4px; }
    .chat-area::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }

    /* Empty state */
    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      text-align: center;
      gap: 12px;
      animation: fadeUp 0.5s ease both;
    }

    .empty-icon { font-size: 3rem; opacity: 0.4; }

    .empty-state h2 {
      font-family: 'Syne', sans-serif;
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--muted);
    }

    .empty-state p { font-size: 0.72rem; color: var(--muted); opacity: 0.6; line-height: 1.7; max-width: 300px; }

    @keyframes fadeUp {
      from { opacity: 0; transform: translateY(12px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    /* Messages */
    .message { display: flex; gap: 12px; animation: fadeUp 0.35s ease both; }
    .message.user { flex-direction: row-reverse; }

    .avatar {
      width: 28px; height: 28px;
      border-radius: 6px;
      display: grid; place-items: center;
      font-size: 0.62rem; font-weight: 700;
      flex-shrink: 0;
      font-family: 'Syne', sans-serif;
    }

    .message.user .avatar { background: var(--accent); color: #0b0c0f; }
    .message.ai .avatar { background: var(--surface2); border: 1px solid var(--border); color: var(--accent2); }

    .bubble {
      max-width: 78%;
      padding: 12px 16px;
      border-radius: 12px;
      font-size: 0.76rem;
      line-height: 1.75;
    }

    .message.user .bubble {
      background: var(--user-bg);
      border: 1px solid rgba(127,255,110,0.2);
      border-top-right-radius: 3px;
    }

    .message.ai .bubble {
      background: var(--ai-bg);
      border: 1px solid var(--border);
      border-top-left-radius: 3px;
      white-space: pre-wrap;
    }

    .typing .bubble { display: flex; align-items: center; gap: 5px; padding: 14px 18px; }

    .dot { width: 6px; height: 6px; border-radius: 50%; background: var(--accent); animation: bounce 1.2s ease-in-out infinite; }
    .dot:nth-child(2) { animation-delay: 0.2s; background: var(--accent2); }
    .dot:nth-child(3) { animation-delay: 0.4s; }

    @keyframes bounce {
      0%,80%,100% { transform: translateY(0); opacity: 0.4; }
      40% { transform: translateY(-6px); opacity: 1; }
    }

    /* Input */
    .input-area { padding: 16px 28px 24px; border-top: 1px solid var(--border); }

    .input-wrapper {
      display: flex;
      gap: 10px;
      align-items: flex-end;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 10px 10px 10px 18px;
      transition: border-color 0.2s ease;
    }

    .input-wrapper:focus-within { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(127,255,110,0.07); }

    textarea {
      flex: 1; background: transparent; border: none; outline: none;
      color: var(--text); font-family: 'DM Mono', monospace;
      font-size: 0.76rem; line-height: 1.6; resize: none;
      max-height: 120px; min-height: 24px;
    }

    textarea::placeholder { color: var(--muted); }

    textarea:disabled { opacity: 0.4; cursor: not-allowed; }

    .send-btn {
      width: 34px; height: 34px; border-radius: 8px;
      background: var(--accent); border: none; cursor: pointer;
      display: grid; place-items: center; flex-shrink: 0;
      transition: all 0.2s ease;
    }

    .send-btn:hover:not(:disabled) { background: var(--accent2); transform: scale(1.05); }
    .send-btn:active:not(:disabled) { transform: scale(0.97); }
    .send-btn:disabled { opacity: 0.3; cursor: not-allowed; }
    .send-btn svg { width: 15px; height: 15px; fill: #0b0c0f; }

    .input-hint { font-size: 0.62rem; color: var(--muted); margin-top: 8px; text-align: center; }
    kbd { background: var(--surface2); padding: 1px 5px; border-radius: 3px; border: 1px solid var(--border); }
  </style>
</head>
<body>
<div class="app">

  <!-- ‚îÄ‚îÄ Sidebar ‚îÄ‚îÄ -->
  <aside class="sidebar">
    <div class="sidebar-logo">
      <div class="logo-box">
        <svg viewBox="0 0 24 24"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/></svg>
      </div>
      <div class="logo-text">
        <h1>RAG Assistant</h1>
        <p>Document Q&A ¬∑ Powered by GPT</p>
      </div>
    </div>

    <div>
      <p class="sidebar-section-title">Upload Document</p>
    </div>

    <!-- Upload Zone -->
    <div class="upload-zone" id="uploadZone">
      <input type="file" id="fileInput" accept=".pdf,.docx,.txt" onchange="handleFileSelect(event)"/>
      <div class="upload-icon">üìÇ</div>
      <p>Drop your file here or <span>browse</span></p>
      <div class="file-types">
        <span class="file-badge">PDF</span>
        <span class="file-badge">DOCX</span>
        <span class="file-badge">TXT</span>
      </div>
    </div>

    <!-- Upload Progress -->
    <div class="upload-status" id="uploadStatus">
      <div class="upload-status-text" id="uploadStatusText">Processing...</div>
      <div class="progress-bar-wrap">
        <div class="progress-bar" id="progressBar"></div>
      </div>
    </div>

    <!-- Active Document -->
    <div class="active-doc" id="activeDoc">
      <div class="doc-header">
        <div class="doc-icon" id="docIcon">üìÑ</div>
        <div class="doc-info">
          <div class="doc-name" id="docName">filename.pdf</div>
          <div class="doc-meta">‚úÖ Ready to query</div>
        </div>
      </div>
      <button class="doc-clear-btn" onclick="clearSession()">üóë Remove & upload new</button>
    </div>

    <div>
      <p class="sidebar-section-title">Quick Prompts</p>
    </div>

    <div class="suggestions-list">
      <button class="suggestion-btn" id="s1" disabled onclick="fillSuggestion(this)">üìù Summarize this document</button>
      <button class="suggestion-btn" id="s2" disabled onclick="fillSuggestion(this)">‚ùì Create 3 MCQ questions</button>
      <button class="suggestion-btn" id="s3" disabled onclick="fillSuggestion(this)">‚úÖ Give me 5 true or false</button>
      <button class="suggestion-btn" id="s4" disabled onclick="fillSuggestion(this)">üåç Translate key points to French</button>
    </div>
  </aside>

  <!-- ‚îÄ‚îÄ Main ‚îÄ‚îÄ -->
  <div class="main">
    <div class="top-bar">
      <div class="top-bar-left">
        Active file: <span id="topBarFile">None</span>
      </div>
      <div class="status">
        <div class="status-dot"></div>
        <span>API Connected</span>
      </div>
    </div>

    <div class="chat-area" id="chatArea">
      <div class="empty-state" id="emptyState">
        <div class="empty-icon">‚¨ÜÔ∏è</div>
        <h2>Upload a document to begin</h2>
        <p>Support PDF, DOCX, and TXT files. Once uploaded, you can ask questions, generate MCQs, summaries, translations, and more.</p>
      </div>
    </div>

    <div class="input-area">
      <div class="input-wrapper">
        <textarea
          id="questionInput"
          placeholder="Upload a document first..."
          rows="1"
          disabled
          onkeydown="handleKeyDown(event)"
          oninput="autoResize(this)"
        ></textarea>
        <button class="send-btn" id="sendBtn" disabled onclick="sendMessage()">
          <svg viewBox="0 0 24 24"><path d="M22 2L11 13M22 2L15 22l-4-9-9-4 20-7z"/></svg>
        </button>
      </div>
      <p class="input-hint"><kbd>Enter</kbd> to send ¬∑ <kbd>Shift+Enter</kbd> for new line</p>
    </div>
  </div>

</div>

<script>
  const API = 'http://localhost:8000';
  let sessionId = null;

  // ‚îÄ‚îÄ Drag and Drop ‚îÄ‚îÄ
  const zone = document.getElementById('uploadZone');
  zone.addEventListener('dragover', e => { e.preventDefault(); zone.classList.add('drag-over'); });
  zone.addEventListener('dragleave', () => zone.classList.remove('drag-over'));
  zone.addEventListener('drop', e => {
    e.preventDefault();
    zone.classList.remove('drag-over');
    const file = e.dataTransfer.files[0];
    if (file) uploadFile(file);
  });

  function handleFileSelect(e) {
    const file = e.target.files[0];
    if (file) uploadFile(file);
  }

  function getFileIcon(filename) {
    const ext = filename.split('.').pop().toLowerCase();
    return ext === 'pdf' ? 'üìï' : ext === 'docx' ? 'üìò' : 'üìÑ';
  }

  async function uploadFile(file) {
    const allowed = ['pdf', 'docx', 'txt'];
    const ext = file.name.split('.').pop().toLowerCase();
    if (!allowed.includes(ext)) {
      alert(`‚ùå Unsupported file type. Please upload PDF, DOCX, or TXT.`);
      return;
    }

    // Show progress
    document.getElementById('uploadZone').style.display = 'none';
    const statusEl = document.getElementById('uploadStatus');
    statusEl.classList.add('show');
    document.getElementById('uploadStatusText').textContent = `Uploading ${file.name}...`;
    animateProgress(30);

    const formData = new FormData();
    formData.append('file', file);

    try {
      document.getElementById('uploadStatusText').textContent = `Processing with LangChain...`;
      animateProgress(70);

      const res = await fetch(`${API}/upload`, { method: 'POST', body: formData });
      const data = await res.json();

      if (!res.ok) throw new Error(data.detail || 'Upload failed');

      animateProgress(100);
      sessionId = data.session_id;

      setTimeout(() => {
        statusEl.classList.remove('show');
        document.getElementById('progressBar').style.width = '0%';

        // Show active doc card
        document.getElementById('docName').textContent = file.name;
        document.getElementById('docIcon').textContent = getFileIcon(file.name);
        document.getElementById('activeDoc').classList.add('show');
        document.getElementById('topBarFile').textContent = file.name;

        // Enable input + suggestions
        const input = document.getElementById('questionInput');
        input.disabled = false;
        input.placeholder = 'Ask a question about your document...';
        document.getElementById('sendBtn').disabled = false;
        ['s1','s2','s3','s4'].forEach(id => document.getElementById(id).disabled = false);

        // Add system message
        appendAIMessage(`‚úÖ **${file.name}** is ready! Ask me anything about it ‚Äî summaries, MCQs, Q&A, translations, and more.`);
        input.focus();
      }, 400);

    } catch (err) {
      statusEl.classList.remove('show');
      document.getElementById('uploadZone').style.display = 'block';
      document.getElementById('progressBar').style.width = '0%';
      document.getElementById('fileInput').value = '';
      alert(`‚ùå ${err.message}`);
    }
  }

  function animateProgress(target) {
    const bar = document.getElementById('progressBar');
    bar.style.width = target + '%';
  }

  async function clearSession() {
    if (sessionId) {
      await fetch(`${API}/session/${sessionId}`, { method: 'DELETE' }).catch(() => {});
      sessionId = null;
    }

    document.getElementById('activeDoc').classList.remove('show');
    document.getElementById('uploadZone').style.display = 'block';
    document.getElementById('fileInput').value = '';
    document.getElementById('topBarFile').textContent = 'None';

    const input = document.getElementById('questionInput');
    input.disabled = true;
    input.placeholder = 'Upload a document first...';
    document.getElementById('sendBtn').disabled = true;
    ['s1','s2','s3','s4'].forEach(id => document.getElementById(id).disabled = true);

    // Clear chat
    const area = document.getElementById('chatArea');
    area.innerHTML = `
      <div class="empty-state" id="emptyState">
        <div class="empty-icon">‚¨ÜÔ∏è</div>
        <h2>Upload a document to begin</h2>
        <p>Support PDF, DOCX, and TXT files. Once uploaded, you can ask questions, generate MCQs, summaries, translations, and more.</p>
      </div>`;
  }

  // ‚îÄ‚îÄ Chat ‚îÄ‚îÄ
  function autoResize(el) {
    el.style.height = 'auto';
    el.style.height = Math.min(el.scrollHeight, 120) + 'px';
  }

  function handleKeyDown(e) {
    if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
  }

  function fillSuggestion(btn) {
    const input = document.getElementById('questionInput');
    input.value = btn.textContent.replace(/^[^\s]+\s/, '');
    autoResize(input);
    input.focus();
  }

  function scrollToBottom() {
    const area = document.getElementById('chatArea');
    area.scrollTop = area.scrollHeight;
  }

  function removeEmptyState() {
    const es = document.getElementById('emptyState');
    if (es) es.remove();
  }

  function appendUserMessage(text) {
    removeEmptyState();
    const area = document.getElementById('chatArea');
    const msg = document.createElement('div');
    msg.className = 'message user';
    msg.innerHTML = `<div class="avatar">YOU</div><div class="bubble">${escapeHtml(text)}</div>`;
    area.appendChild(msg);
    scrollToBottom();
  }

  function appendAIMessage(text) {
    removeEmptyState();
    const area = document.getElementById('chatArea');
    const msg = document.createElement('div');
    msg.className = 'message ai';
    msg.innerHTML = `<div class="avatar">AI</div><div class="bubble">${escapeHtml(text)}</div>`;
    area.appendChild(msg);
    scrollToBottom();
  }

  function showTyping() {
    removeEmptyState();
    const area = document.getElementById('chatArea');
    const msg = document.createElement('div');
    msg.className = 'message ai typing';
    msg.id = 'typingIndicator';
    msg.innerHTML = `<div class="avatar">AI</div><div class="bubble"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>`;
    area.appendChild(msg);
    scrollToBottom();
  }

  function removeTyping() {
    const t = document.getElementById('typingIndicator');
    if (t) t.remove();
  }

  function escapeHtml(text) {
    return text.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  }

  async function sendMessage() {
    const input = document.getElementById('questionInput');
    const sendBtn = document.getElementById('sendBtn');
    const question = input.value.trim();
    if (!question || !sessionId) return;

    input.value = '';
    input.style.height = 'auto';
    sendBtn.disabled = true;

    appendUserMessage(question);
    showTyping();

    try {
      const res = await fetch(`${API}/ask`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ session_id: sessionId, question })
      });

      const data = await res.json();
      if (!res.ok) throw new Error(data.detail || 'Server error');

      removeTyping();
      appendAIMessage(data.answer);
    } catch (err) {
      removeTyping();
      appendAIMessage(`‚ö†Ô∏è Error: ${err.message}`);
    } finally {
      sendBtn.disabled = false;
      input.focus();
    }
  }
</script>
</body>
</html>